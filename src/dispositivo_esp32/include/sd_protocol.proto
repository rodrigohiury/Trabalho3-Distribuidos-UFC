syntax = "proto3";

package cidade;

// ----------------------------------------------------------------
// 1. DESCOBERTA (UDP Multicast: 224.0.0.1:5000)
// ----------------------------------------------------------------

// Mensagem que os dispositivos enviam ao receber o trigger "WHO_IS_OUT_THERE"
message DiscoveryResponse {
    string id = 1;          // Ex: "ESP32_ALARM_01", "VIRTUAL_TEMP_01"
    string tipo = 2;        // Ex: "ALARM_SYSTEM", "SENSOR_TEMPERATURA"
    string ip = 3;          // IP do dispositivo para o Gateway saber onde conectar
    int32 porta_tcp = 4;    // Porta onde o dispositivo ouve comandos
}

// ----------------------------------------------------------------
// 2. DADOS DOS SENSORES (UDP Unicast -> Gateway:5000)
// ----------------------------------------------------------------

message SensorData {
    string id = 1;          // Quem está enviando
    int64 timestamp = 2;    // Momento da leitura
    
    // Usamos 'oneof' para economizar bytes e organizar os dados
    oneof leitura {
        float temperatura = 3;      // Para o sensor Python
        float umidade = 4;          // Para o sensor Node.js
        AmbienteData ambiente = 5;  // Para o ESP32 (Som + Luz + Status)
    }
}

message AmbienteData {
    float nivel_som = 1;
    float luminosidade = 2;
    bool alarme_ativo = 3;  // Estado do LED/Alarme
}

// ----------------------------------------------------------------
// 3. COMUNICAÇÃO TCP (Cliente <-> Gateway <-> Dispositivos)
// ----------------------------------------------------------------

// Wrapper geral para qualquer mensagem TCP para facilitar o decode
message TcpMessage {
    string id_origem = 1;    // Quem mandou? (Ex: "CLIENTE_WEB", "GATEWAY")
    string id_destino = 2;   // Para quem? (Ex: "ESP32_ALARM_01", "GATEWAY")
    
    oneof payload {
        Command comando = 3;             // Mudar algo
        CommandResponse resposta = 4;    // Confirmar que mudou
        GetDeviceList listar_todos = 5;  // Cliente pede lista
        DeviceList lista_atual = 6;      // Gateway entrega lista
    }
}

// Comando Genérico (Cobre os requisitos de configuração do PDF)
message Command {
    // Tipo de ação: "SET", "GET", "ACTION"
    string type = 1; 
    
    // O que mudar? Ex: "led", "resolucao", "intervalo_leitura"
    string param = 2; 
    
    // Novo valor (enviado como string para flexibilidade: "ON", "4k", "15.5")
    string value = 3; 
}

// Confirmação de execução
message CommandResponse {
    string status = 1;       // "OK", "ERRO"
    string mensagem = 2;     // Detalhe do erro ou sucesso
}

// Cliente pede a lista de dispositivos
message GetDeviceList {
    bool apenas_ativos = 1;
}

// Gateway responde com o snapshot da rede
message DeviceList {
    repeated DeviceInfo dispositivos = 1;
}

message DeviceInfo {
    string id = 1;
    string tipo = 2;
    string ip = 3;
    bool ativo = 4;
    int64 ultima_vez_visto = 5;
}